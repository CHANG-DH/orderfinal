<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 관리 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.view-active { background-color: #4f46e5; color: white; }
        .tab-btn.collection-active { box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.7); } /* emerald-400 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .summary-card, .order-card { animation: fadeIn 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold text-gray-800">주문 관리 대시보드</h1>
            <p class="text-gray-600 mt-2">일자를 선택해 주문을 관리하고, 새 일차를 시작하세요.</p>
        </header>

        <div id="day-tabs-container" class="mb-6 flex items-center justify-center flex-wrap gap-2">
            <!-- 일자 탭 템플릿 -->
            <template id="day-tab-template">
                <div class="relative">
                    <button class="tab-btn px-4 py-2 rounded-md font-semibold text-sm bg-white shadow"></button>
                </div>
            </template>
            <button id="add-day-btn" class="px-3 py-2 bg-green-500 text-white rounded-md font-bold text-sm hover:bg-green-600 shadow">+</button>
        </div>

        <section id="summary-section" class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-lg summary-card">
                <h2 class="text-xl font-bold text-gray-700 mb-2">일일 총 매출</h2>
                <p id="total-revenue" class="text-4xl font-extrabold text-indigo-600">0원</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg summary-card">
                <h2 class="text-xl font-bold text-gray-700 mb-2">일일 메뉴별 판매량</h2>
                <div id="menu-sales" class="space-y-2 text-gray-800"><p class="text-gray-500">날짜를 선택해주세요.</p></div>
            </div>
        </section>

        <main id="order-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></main>

        <template id="order-card-template">
            <div class="bg-white rounded-xl shadow-lg p-5 flex flex-col transition-opacity duration-500 relative order-card">
                <button class="delete-order-btn absolute top-3 right-3 text-gray-400 hover:text-red-600 z-10"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                <div class="text-right"><span class="order-time text-xs text-gray-500"></span></div>
                <div class="flex justify-between items-start mb-3"><h2 class="text-2xl font-bold text-indigo-600">테이블 <span class="table-number"></span></h2></div>
                <div class="order-items border-t border-b border-gray-200 py-3 my-3 space-y-2 text-gray-700 flex-grow"></div>
                <div class="text-right mb-4"><span class="text-lg font-semibold">총 금액:</span><span class="total-price text-xl font-bold text-gray-900"></span></div>
                <div class="status-btn-group grid grid-cols-2 gap-2 text-sm">
                    <button data-status="주문 접수 중" class="p-2 rounded-md font-semibold">접수 중</button>
                    <button data-status="요리 중" class="p-2 rounded-md font-semibold">요리 중</button>
                    <button data-status="서빙 완료" class="p-2 rounded-md font-semibold">서빙 완료</button>
                    <button data-status="처리 완료" class="p-2 rounded-md font-semibold">처리 완료</button>
                </div>
            </div>
        </template>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50"><div class="bg-white p-8 rounded-xl shadow-2xl text-center w-11/12 max-w-sm"><h2 class="text-xl font-bold text-red-600 mb-4">정말로 삭제하시겠습니까?</h2><p class="text-gray-700 mb-6">이 주문 내역은 영구적으로 삭제되며, 복구할 수 없습니다.</p><div class="flex justify-center space-x-4"><button id="cancel-delete" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 font-semibold">취소</button><button id="confirm-delete" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">삭제</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy, getDoc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
  		apiKey: "AIzaSyAWzxJrQROhzSnVJCmTEUDfpYn-TJqHbHQ",
  		authDomain: "order-4f8a2.firebaseapp.com",
 		projectId: "order-4f8a2",
  		storageBucket: "order-4f8a2.firebasestorage.app",
  		messagingSenderId: "69210404028",
  		appId: "1:69210404028:web:25fe58abbcbff4d1e9ccb9",
  		measurementId: "G-JBK15C76HS"
		};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allOrders = [];
        let config = { dayTabs: [], activeDay: null };
        let viewingDay = null;
        const configRef = doc(db, "festivalConfig", "settings");

        const dayTabsContainer = document.getElementById('day-tabs-container');
        const dayTabTemplate = document.getElementById('day-tab-template');
        const addDayBtn = document.getElementById('add-day-btn');
        const orderList = document.getElementById('order-list');
        const orderCardTemplate = document.getElementById('order-card-template');
        const totalRevenueEl = document.getElementById('total-revenue');
        const menuSalesEl = document.getElementById('menu-sales');

        const statusStyles = {
            "주문 접수 중": { button: "bg-yellow-100 text-yellow-800", cardBorder: "border-4 border-yellow-400" },
            "요리 중": { button: "bg-blue-100 text-blue-800", cardBorder: "border-4 border-blue-400" },
            "서빙 완료": { button: "bg-green-100 text-green-800", cardBorder: "border-4 border-green-400" },
            "처리 완료": { button: "bg-gray-200 text-gray-500", cardBorder: "" }
        };
        
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '';
            return new Date(timestamp.seconds * 1000).toLocaleString('ko-KR', {
                year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short',
                hour: '2-digit', minute: '2-digit'
            });
        };

        function renderDashboard() {
            const ordersToDisplay = allOrders.filter(order => order.festivalDay === viewingDay);
            
            let totalRevenue = 0;
            const menuSales = {};
            ordersToDisplay.forEach(order => {
                totalRevenue += order.totalPrice;
                order.items.forEach(item => { menuSales[item.name] = (menuSales[item.name] || 0) + item.quantity; });
            });

            totalRevenueEl.textContent = `${totalRevenue.toLocaleString()}원`;
            menuSalesEl.innerHTML = '';
            if (Object.keys(menuSales).length > 0) {
                Object.entries(menuSales).sort(([,a],[,b]) => b-a).forEach(([name, quantity]) => {
                    const p = document.createElement('p');
                    p.className = 'flex justify-between font-medium';
                    p.innerHTML = `<span>${name}</span><span>${quantity}개</span>`;
                    menuSalesEl.appendChild(p);
                });
            } else {
                menuSalesEl.innerHTML = '<p class="text-gray-500">해당 일차의 주문이 없습니다.</p>';
            }

            orderList.innerHTML = '';
            const statusPriority = { "주문 접수 중": 1, "요리 중": 2, "서빙 완료": 3, "처리 완료": 4 };
            ordersToDisplay.sort((a, b) => (statusPriority[a.status] || 99) - (statusPriority[b.status] || 99));

            ordersToDisplay.forEach(order => {
                const card = orderCardTemplate.content.cloneNode(true);
                const cardDiv = card.querySelector('.bg-white');
                card.querySelector('.delete-order-btn').addEventListener('click', () => showDeleteModal(order.id));
                card.querySelector('.order-time').textContent = formatTimestamp(order.timestamp);
                card.querySelector('.table-number').textContent = order.tableNumber;
                card.querySelector('.total-price').textContent = `${order.totalPrice.toLocaleString()}원`;
                
                const itemsContainer = card.querySelector('.order-items');
                itemsContainer.innerHTML = '';
                order.items.forEach(item => {
                    const p = document.createElement('p');
                    p.innerHTML = `<span class="flex justify-between"><span>${item.name}</span><span>x${item.quantity}</span></span>`;
                    itemsContainer.appendChild(p);
                });

                card.querySelectorAll('.status-btn-group button').forEach(btn => {
                    const status = btn.dataset.status;
                    btn.className += (status === order.status) ? ` ${statusStyles[status].button}` : ' bg-gray-200 hover:bg-gray-300';
                    btn.addEventListener('click', () => updateDoc(doc(db, "orders", order.id), { status }));
                });

                const currentStyle = statusStyles[order.status];
                if (currentStyle?.cardBorder) cardDiv.classList.add(...currentStyle.cardBorder.split(' '));
                if (order.status === '처리 완료') cardDiv.classList.add('opacity-50');
                orderList.appendChild(card);
            });
        }

        function renderTabs() {
            const existingTabs = dayTabsContainer.querySelectorAll('.relative');
            existingTabs.forEach(tab => tab.remove());

            config.dayTabs.forEach(day => {
                const tabClone = dayTabTemplate.content.cloneNode(true);
                const button = tabClone.querySelector('button');
                button.textContent = `${day}일차`;
                button.dataset.day = day;

                if (day === viewingDay) button.classList.add('view-active');
                if (day === config.activeDay) button.classList.add('collection-active');

                button.addEventListener('click', () => {
                    viewingDay = day;
                    renderTabs();
                    renderDashboard();
                });
                
                // '활성화' 버튼 대신 탭 자체를 눌러서 활성화하도록 변경
                button.addEventListener('dblclick', async () => {
                    if (confirm(`${day}일차를 주문 수집일로 활성화하시겠습니까?`)) {
                         await setDoc(configRef, { activeDay: day }, { merge: true });
                    }
                });

                dayTabsContainer.insertBefore(tabClone, addDayBtn);
            });
             // 더블클릭 안내 툴팁
            const activeTab = dayTabsContainer.querySelector('.collection-active');
            if(activeTab && !activeTab.querySelector('.tooltip')){
                const tooltip = document.createElement('span');
                tooltip.textContent = '주문 수집 중! (더블클릭으로 변경)';
                tooltip.className = 'tooltip absolute -top-7 left-1/2 -translate-x-1/2 text-xs bg-black text-white px-2 py-1 rounded-md whitespace-nowrap';
                activeTab.parentElement.appendChild(tooltip);
            }
        }

        addDayBtn.addEventListener('click', async () => {
            const nextDay = config.dayTabs.length > 0 ? Math.max(...config.dayTabs) + 1 : 1;
            await setDoc(configRef, { dayTabs: arrayUnion(nextDay) }, { merge: true });
        });

        // 삭제 모달
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        let orderIdToDelete = null;
        function showDeleteModal(orderId) { orderIdToDelete = orderId; deleteModal.classList.remove('hidden'); }
        function hideDeleteModal() { orderIdToDelete = null; deleteModal.classList.add('hidden'); }
        cancelDeleteBtn.addEventListener('click', hideDeleteModal);
        confirmDeleteBtn.addEventListener('click', async () => {
            if (orderIdToDelete) {
                await deleteDoc(doc(db, "orders", orderIdToDelete));
                hideDeleteModal();
            }
        });

        // 초기화 및 실시간 리스너
        onSnapshot(configRef, async (docSnap) => {
            if (docSnap.exists()) {
                config = { dayTabs: [], activeDay: 1, ...docSnap.data() };
                if (viewingDay === null && config.dayTabs.length > 0) {
                    viewingDay = config.activeDay || Math.max(...config.dayTabs);
                }
            } else {
                await setDoc(configRef, { dayTabs: [1], activeDay: 1 });
            }
            renderTabs();
            renderDashboard();
        });

        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snapshot) => {
            allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderDashboard();
        });
    </script>
</body>
</html>
