<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 관리 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.view-active { background-color: #4f46e5; color: white; }
        .tab-btn.collection-active { box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.7); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .summary-card, .order-card { animation: fadeIn 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center my-6">
            <h1 class="text-4xl font-bold text-gray-800">주문 관리 대시보드</h1>
            <p class="text-gray-600 mt-2">일자를 선택해 주문을 관리하고, 새 일차를 시작하세요.</p>
        </header>

        <div id="day-tabs-container" class="mb-6 flex items-center justify-center flex-wrap gap-3"></div>
        <section id="summary-section" class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6"></section>
        <main id="order-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></main>
    </div>

    <div id="modal-container" class="fixed inset-0 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, deleteDoc, orderBy, getDocs, setDoc, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
  		apiKey: "AIzaSyAWzxJrQROhzSnVJCmTEUDfpYn-TJqHbHQ",
  		authDomain: "order-4f8a2.firebaseapp.com",
  		projectId: "order-4f8a2",
  		storageBucket: "order-4f8a2.firebasestorage.app",
  		messagingSenderId: "69210404028",
  		appId: "1:69210404028:web:25fe58abbcbff4d1e9ccb9",
  		measurementId: "G-JBK15C76HS"
		};
        
        if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            // ... (Firebase 설정 오류 안내 HTML)
        }
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const DELETE_PASSWORD = "1234";
        let allOrders = [];
        let config = { dayTabs: [], activeDay: null };
        let viewingDay = 'all';
        const configRef = doc(db, "festivalConfig", "settings");

        const dayTabsContainer = document.getElementById('day-tabs-container');
        const summarySection = document.getElementById('summary-section');
        const orderList = document.getElementById('order-list');
        const modalContainer = document.getElementById('modal-container');

        const formatTimestamp = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '';

        function renderDashboard() {
            const isTotalView = viewingDay === 'all';
            const ordersToDisplay = isTotalView ? allOrders : allOrders.filter(order => order.festivalDay === viewingDay);
            
            let totalRevenue = 0;
            const menuSales = {};
            ordersToDisplay.forEach(order => {
                totalRevenue += order.totalPrice;
                order.items.forEach(item => { menuSales[item.name] = (menuSales[item.name] || 0) + item.quantity; });
            });

            summarySection.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg summary-card">
                    <h2 class="text-xl font-bold text-gray-700 mb-2">${isTotalView ? '전체 총 매출' : '일일 총 매출'}</h2>
                    <p class="text-4xl font-extrabold text-indigo-600">${totalRevenue.toLocaleString()}원</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg summary-card">
                    <h2 class="text-xl font-bold text-gray-700 mb-2">${isTotalView ? '전체 메뉴별 판매량' : '일일 메뉴별 판매량'}</h2>
                    <div class="space-y-2 text-gray-800">${Object.keys(menuSales).length > 0 ? Object.entries(menuSales).sort(([,a],[,b]) => b-a).map(([name, q]) => `<p class="flex justify-between font-medium"><span>${name}</span><span>${q}개</span></p>`).join('') : '<p class="text-gray-500">해당 일차의 주문이 없습니다.</p>'}</div>
                </div>`;

            orderList.innerHTML = '';
            const statusPriority = { "주문 접수 중": 1, "요리 중": 2, "서빙 완료": 3, "처리 완료": 4 };
            ordersToDisplay.sort((a, b) => (statusPriority[a.status] || 99) - (statusPriority[b.status] || 99));
            ordersToDisplay.forEach(order => orderList.innerHTML += createOrderCardHTML(order));
        }
        
        function createOrderCardHTML(order) {
            const statusStyles = { "주문 접수 중": "border-yellow-400", "요리 중": "border-blue-400", "서빙 완료": "border-green-400", "처리 완료": "" };
            const statusBtnStyles = { "주문 접수 중": "bg-yellow-100 text-yellow-800", "요리 중": "bg-blue-100 text-blue-800", "서빙 완료": "bg-green-100 text-green-800", "처리 완료": "bg-gray-200 text-gray-500" };
            return `
            <div class="bg-white rounded-xl shadow-lg p-5 flex flex-col transition-opacity duration-500 relative order-card border-4 ${statusStyles[order.status] || ''} ${order.status === '처리 완료' ? 'opacity-50' : ''}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h2 class="text-2xl font-bold text-indigo-600">테이블 ${order.tableNumber}</h2>
                        <p class="text-sm text-gray-500 font-semibold">주문번호: <span class="text-black">${order.orderNumber || '없음'}</span></p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <button onclick="showDeleteModal('${order.id}')" class="text-gray-400 hover:text-red-600 z-10 block ml-auto w-6 h-6"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                        <span class="order-time text-xs text-gray-500 block mt-1">${formatTimestamp(order.timestamp)}</span>
                    </div>
                </div>
                <div class="order-items border-t border-b border-gray-200 py-3 my-3 space-y-2 text-gray-700 flex-grow">${order.items.map(item => `<p class="flex justify-between"><span>${item.name}</span><span>x${item.quantity}</span></p>`).join('')}</div>
                <div class="text-right mb-4"><span class="text-lg font-semibold">총 금액:</span><span class="total-price text-xl font-bold text-gray-900">${order.totalPrice.toLocaleString()}원</span></div>
                <div class="status-btn-group grid grid-cols-2 gap-2 text-sm">${Object.keys(statusBtnStyles).map(status => `<button onclick="updateStatus('${order.id}', '${status}')" class="p-2 rounded-md font-semibold ${status === order.status ? statusBtnStyles[status] : 'bg-gray-200 hover:bg-gray-300'}">${status}</button>`).join('')}</div>
            </div>`;
        }

        function renderTabs() {
            // ... (renderTabs 함수는 이전과 동일)
        }

        // --- 모달 및 전역 함수 ---
        // ... (모달 관련 함수들은 이전과 동일)

        onSnapshot(configRef, async (docSnap) => {
            // ... (onSnapshot(configRef) 함수는 이전과 동일, 단 tableAuthCodes 관련 로직 제거)
        });

        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snapshot) => {
            allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderDashboard();
        });

        // 나머지 window 함수들 (showDateModal, saveDate 등)은 이전 코드와 동일하게 유지됩니다.
    </script>
</body>
</html>
